<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script src="pixel.js"></script>
<script>
    pixel.init('checkbox');
    var bg = pixel.bgInfo();
    var cube = {
        /*        model: {
         l: {
         m: [[-2, -3], [-1, -3], [-2, -2], [-1, -2], [-2, -1], [-1, -1], [-2, 0], [-1, 0], [-2, 1], [-1, 1], [0, 1], [1, 1], [-2, 2], [-1, 2], [0, 2], [1, 2]],
         t: [[-2, -4], [-1, -4], [0, 0], [1, 0]],
         r: [[0, -3], [0, -2], [0, -1], [0, 0], [2, 1], [2, 2]],
         b: [[-2, 3], [-1, 3], [0, 3], [1, 3]],
         l: [[-3, -3], [-3, -2], [-3, -1], [-3, 0], [-3, 1], [-3, 2]]
         },
         t: {
         m: [[-2, -3], [-1, -3], [-2, -2], [-1, -2], [-2, -1], [-1, -1], [0, -1], [1, -1], [-2, 0], [-1, 0], [0, 0], [1, 0], [-2, 1], [-1, 1], [-2, 2], [-1, 2]],
         t: [[-2, -4], [-1, -4], [0, -2], [1, -2]],
         r: [[0, -3], [0, -2], [2, -1], [2, 0], [0, 1], [0, 2]],
         b: [[0, 1], [1, 1], [-2, 3], [-1, 3]],
         l: [[-3, -3], [-3, -2], [-3, -1], [-3, 0], [-3, 1], [-3, 2]]
         },
         z: {
         m: [[-2, -3], [-1, -3], [-2, -2], [-1, -2], [-2, -1], [-1, -1], [0, -1], [1, -1], [-2, 0], [-1, 0], [0, 0], [1, 0], [0, 1], [1, 1], [0, 2], [1, 2]],
         t: [[-2, -4], [-1, -4], [0, -2], [1, -2]],
         r: [[0, -3], [0, -2], [2, -1], [2, 0], [2, 1], [2, 2]],
         b: [[-2, 1], [-1, 1], [0, 3], [1, 3]],
         l: [[-3, -3], [-3, -2], [-3, -1], [-3, 0], [-1, 1], [-1, 2]]
         }/!*,
         l:{
         m:,
         t:,
         r:,
         b:,
         l:
         },
         l:{
         m:,
         t:,
         r:,
         b:,
         l:
         },
         l:{
         m:,
         t:,
         r:,
         b:,
         l:
         },
         l:{
         m:,
         t:,
         r:,
         b:,
         l:
         },
         l:{
         m:,
         t:,
         r:,
         b:,
         l:
         },*!/

         },
         randomModel: function () {
         var n = (3 * Math.random())._floor();
         var t = (4 * Math.random())._floor();
         var s = 'ltz';
         var m = this.model[s.charAt(n)];
         return this.turn(m, t);
         },*/
        model: [
            //L
            [[-2, -2], [-1, -2], [-2, -1], [-1, -1], [-2, 0], [-1, 0], [-2, 1], [-1, 1], [-2, 2], [-1, 2], [0, 2], [1, 2], [-2, 3], [-1, 3], [0, 3], [1, 3]],
            //T
            [[-2, -2], [-1, -2], [-2, -1], [-1, -1], [-2, 0], [-1, 0], [0, 0], [1, 0], [-2, 1], [-1, 1], [0, 1], [1, 1], [-2, 2], [-1, 2], [-2, 3], [-1, 3]],
            //Z
            [[-2, -2], [-1, -2], [-2, -1], [-1, -1], [-2, 0], [-1, 0], [0, 0], [1, 0], [-2, 1], [-1, 1], [0, 1], [1, 1], [0, 2], [1, 2], [0, 3], [1, 3]],
            //|
            [[-2, -2], [-1, -2], [-2, -1], [-1, -1], [-2, 0], [-1, 0], [-2, 1], [-1, 1], [-2, 2], [-1, 2], [-2, 3], [-1, 3], [-2, 4], [-1, 4], [-2, 5], [-1, 5]],
            //o
            [[-2, -2], [-1, -2], [0, -2], [1, -2], [-2, -1], [-1, -1], [0, -1], [1, -1], [-2, 0], [-1, 0], [0, 0], [1, 0], [-2, 1], [-1, 1], [0, 1], [1, 1]],
            //[
            [[-2, -2], [-1, -2], [0, -2], [1, -2], [-2, -1], [-1, -1], [0, -1], [1, -1], [-2, 0], [-1, 0], [-2, 1], [-1, 1], [-2, 2], [-1, 2], [0, 2], [1, 2], [-2, 3], [-1, 3], [0, 3], [1, 3]],
            //L2
            [[0, -2], [1, -2], [0, -1], [1, -1], [0, 0], [1, 0], [0, 1], [1, 1], [-2, 2], [-1, 2], [0, 2], [1, 2], [-2, 3], [-1, 3], [0, 3], [1, 3]],
            //Z2
            [[0, -2], [1, -2], [0, -1], [1, -1], [-2, 0], [-1, 0], [0, 0], [1, 0], [-2, 1], [-1, 1], [0, 1], [1, 1], [-2, 2], [-1, 2], [-2, 3], [-1, 3]]
        ],
        randomModel: function () {
            var n = (8 * Math.random())._floor();
            var t = (4 * Math.random())._floor();
            var m = this.model[n];
            for (var i = 0; i < t; i++) {
                m = m._transform();
            }
            return m;
        },
        end: Infinity,
        speed: 200,
        turn: function (obj, n) {
            var j = n || 0;
            var s = 'mtrbl';
            for (var i = 0; i < j; i++) {
                for (var k = 0; k < 5; k++) {
                    obj[s.charAt(k)] = obj[s.charAt(k)]._transform();
                }
            }
            return obj
        },
        checkLine:function () {
            //数组，满行行数
            var l = [];
            var f = function (a) {
                //标记点亮的个数
                var c = 0;
                //当前行
                for(var j=a*bg.x;j<(a+1)*bg.x;j++){
                    //如果是选中的，标记个数加1
                    if(bg.btns[j].checked){
                        c++;
                        if(c==bg.x){
                            l.push(a);
                        }
                    }else{
                        //否则标记重置并且返回
                        c = 0;
                        return true;
                    }
                }
            };
            for(var i=0;i<bg.y;i++){
                f(i);
            }
            return l;
        },
        hideLine:function (line) {
//            var line = this.checkLine();
            pixel.animate(function (index) {
                for(var i =0;i<line.length;i++){
                    bg.btns[bg.x*line[i]+index].checked = false;
                }
            },{
                end: bg.x,
                speed: 20
            })
        },
        picDown:function (line) {
            var l = line.sort().reverse()._copy();
            for(var i =0;i<l.length;i++){
                for(){

                }
                bg.btns[bg.x*line[i]+index].checked = false;
            }
        }
    };
    document.onkeydown = function (event) {
        var e = event || window.event || arguments.callee.caller.arguments[0];
        if (e && e.keyCode) {
            switch (e.keyCode) {
                case 37:
                    if (!crossed('left')) {
                        p--;
                    }
                    break;
                case 39:
                    if (!crossed('right')) {
                        p++;
                    }
                    break;
                case 32:
//                    debugger
                    var ed = first._transform();
                    if (!crossed('default', ed)) {
                        pixel.layout(p, first, 'hide');
                        first = first._transform();
                    }
                    console.log('ed');
                    break;
                default:
            }
        }
    };
    var first, p;
    var crossed = function (to, ar) {
        var arr = ar || first;
        var next_p, bottom, side;
        pixel.layout(p, arr, 'hide');
        switch (to) {
            case 'left':
                next_p = p - 1;
                break;
            case 'right':
                next_p = p + 1;
                break;
            case 'bottom':
                next_p = p + bg.x;
                break;
            default:
                next_p = p;
        }
        var next = pixel.toLine(next_p, arr);
        for (var i = 0; i < next.length; i++) {
            if (bg.btns[next[i]] && bg.btns[next[i]].checked) {
                side = true;
            }
        }
        if (bg.all < next.sort().reverse()[0]) {
            bottom = true;
        }
        return side || bottom;
    };

    var test = function () {
        for(var i=22;i<44;i++){
            bg.btns[i].checked=true;
        }
        for(var i=418;i<440;i++){
            bg.btns[i].checked=true;
        }
    };
//    test();


    var move = function () {
        first = cube.randomModel();
        p = (bg.x * 7 / 2)._floor();
        var gameover = (function () {
            var line = pixel.toLine(p, first);
            for (var i = 0; i < line.length; i++) {
                if (bg.btns[line[i]] && bg.btns[line[i]].checked) {
                    return true;
                }
            }
        })();
        if (gameover) {
            pixel.printWord('game over', bg.center - 24);
            pixel.shine();
            document.onkeydown = function () {};
//            location.reload();
        } else {
            pixel.layout(p, first, 'show');
            pixel.animate(function (index, id) {

                if (!crossed('bottom')) {
                    p += bg.x;
                } else {
                    clearInterval(id);
                    pixel.layout(p, first, 'show');
                    var l = cube.checkLine();
                    if(l.length){
                        cube.hideLine(l);
                        setTimeout(move,bg.x*21)
                    }else{
                        move()
                    }
                    return;
                }
                pixel.layout(p, first, 'show');
            }, {
                end: cube.end,
                speed: cube.speed
            });
        }
    };
    move();
</script>
</body>
</html>
