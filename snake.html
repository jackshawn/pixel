<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>贪食蛇</title>
</head>
<body>
<script src="pixel.js"></script>
<script>
    (function () {
        pixel.init('checkbox');
        var bg = pixel.bgInfo();
        pixel.layout(bg.center, [[-19, -17], [-18, -17], [-17, -17], [-6, -17], [-5, -17], [-4, -17], [-3, -17], [-20, -16], [-18, -16], [-16, -16], [-14, -16], [-13, -16], [-12, -16], [-11, -16], [-10, -16], [-9, -16], [-7, -16], [-5, -16], [-3, -16], [-21, -15], [-18, -15], [-15, -15], [-8, -15], [-5, -15], [-2, -15], [-20, -14], [-18, -14], [-16, -14], [-7, -14], [-5, -14], [-3, -14], [-22, -13], [-19, -13], [-18, -13], [-17, -13], [-6, -13], [-5, -13], [-4, -13], [-1, -13], [-23, -12], [0, -12], [-24, -11], [1, -11], [-25, -10], [1, -10], [-25, -9], [0, -9], [-24, -8], [-1, -8], [-23, -7], [-15, -7], [-8, -7], [-2, -7], [-21, -6], [-4, -6], [-3, -6], [-19, -5], [-11, -5], [-5, -5], [-18, -4], [-12, -4], [-10, -4], [-7, -4], [-6, -4], [-16, -3], [-15, -3], [-14, -3], [-13, -3], [-11, -3], [-9, -3], [-8, -3], [-11, -2], [-11, -1], [-7, -1], [-14, 0], [-11, 0], [-7, 0], [-14, 1], [-12, 1], [-10, 1], [-7, 1], [-14, 2], [-7, 2], [2, 2], [3, 2], [4, 2], [5, 2], [6, 2], [7, 2], [8, 2], [9, 2], [-7, 3], [0, 3], [11, 3], [-15, 4], [-7, 4], [-1, 4], [12, 4], [-15, 5], [-7, 5], [-2, 5], [13, 5], [-15, 6], [-7, 6], [-7, 7], [-3, 7], [14, 7], [26, 7], [-16, 8], [-7, 8], [-4, 8], [14, 8], [25, 8], [26, 8], [-16, 9], [-6, 9], [-5, 9], [5, 9], [6, 9], [14, 9], [24, 9], [26, 9], [-16, 10], [4, 10], [7, 10], [15, 10], [16, 10], [17, 10], [18, 10], [19, 10], [20, 10], [21, 10], [22, 10], [25, 10], [-16, 11], [7, 11], [25, 11], [-16, 12], [3, 12], [7, 12], [24, 12], [-15, 13], [7, 13], [-14, 14], [2, 14], [8, 14], [23, 14], [-13, 15], [1, 15], [9, 15], [21, 15], [22, 15], [-11, 16], [-10, 16], [-9, 16], [-8, 16], [-7, 16], [-6, 16], [-5, 16], [-4, 16], [-3, 16], [-2, 16], [-1, 16], [11, 16], [12, 16], [13, 16], [14, 16], [15, 16], [16, 16], [17, 16], [18, 16], [19, 16], [20, 16]], 'show');
        //开始游戏选择界面
        var welcome = {
            playmodel: '',
            arrow: [[0, 0], [0, 1], [0, -1], [0, 2], [0, -2], [1, 0], [1, 1], [1, -1], [2, 0]],
            init: function () {
                pixel.layout(bg.center - bg.x * 6 - 15, this.arrow, 'show');
                pixel.printWord('play', bg.center - bg.x * 6 - 5);
                pixel.printWord('auto', bg.center + bg.x * 6 - 5);
            },
            move: function (i, t) {
                if (this.towards == t) {
                    pixel.move(bg.center + bg.x * i - 15, this.arrow, {
                        towards: t,
                        steps: 12,
                        speed: 10
                    });
                    this.towards = t == 'top' ? 'bottom' : 'top';
                }
            },
            towards: 'bottom'
        };
        setTimeout(function () {
            pixel.clear();
            welcome.init();
            document.onkeydown = function (event) {
                var e = event || window.event || arguments.callee.caller.arguments[0];
                if (e && e.keyCode) {
                    switch (e.keyCode) {
                        case 38:
                            welcome.move(6, 'top');
                            welcome.playmodel = 'play';
                            break;
                        case 40:
                            welcome.move(-6, 'bottom');
                            welcome.playmodel = 'auto';
                            break;
                        case 13:
                            start(welcome.playmodel);
                            break;
                        default:
                    }
                }
            };
        }, 1500);
        //游戏入口
        var start = function (m) {
            pixel.clear();
            pixel.printWord('snake');
            pixel.printWord('score:0', (bg.x * 7 / 2)._floor());
            pixel.box(bg.x * 7 + 1, bg.all - bg.x - 2);
            var snake = {
                model: [[-1, 0], [0, 0], [1, 0]],
                position: bg.center - 1,
                speed: 10,
                end: Infinity,
                head: [1, 0],
                target: 'right',
                noTargetId: 37,
                area: {
                    min: bg.x * 8 + 2,
                    max: bg.all - bg.x * 2 - 3
                },
                scroe: 0,
                gameover: function (i) {
                    pixel.printWord('game over', bg.center - 22 + bg.x * 3);
                    clearInterval(i);
                },
                turn: (function () {
                    var fn = function (i) {
                        switch (i) {
                            case 38:
                                snake.target = 'top';
                                snake.noTargetId = 40;
                                break;
                            case 39:
                                snake.target = 'right';
                                snake.noTargetId = 37;
                                break;
                            case 40:
                                snake.target = 'bottom';
                                snake.noTargetId = 38;
                                break;
                            case 37:
                                snake.target = 'left';
                                snake.noTargetId = 39;
                                break;
                            default:
                        }
                    };
                    document.onkeydown = function (event) {
                        var e = event || window.event || arguments.callee.caller.arguments[0];
                        if (e && e.keyCode != snake.noTargetId) {
                            fn(e.keyCode);
                        }
                    };
                    return fn;
                })(),
                check: function (arr1, arr2) {
                    for (var i = 0; i < arr1.length; i++) {
                        if (arr1[i][0] == arr2[0] && arr1[i][1] == arr2[1]) {
                            return true
                        }
                    }
                }
            };
            var food = function () {
                var m = (snake.area.max - snake.area.min)._random() + snake.area.min;
                var n = m % bg.x;
                if (n == 0 || n == (bg.x - 1) || n == 1 || n == (bg.x - 2) || n == 2 || n == 3) {
                    return food();
                } else {
                    return m;
                }
            };
            var first = food();
            pixel.layout(first, [[0, 0]], 'show');
            var move = function (m) {
                pixel.animate(function (i, id) {
                    switch (snake.target) {
                        case 'top':
                            snake.head[1]--;
                            break;
                        case 'right':
                            snake.head[0]++;
                            break;
                        case 'bottom':
                            snake.head[1]++;
                            break;
                        case 'left':
                            snake.head[0]--;
                            break;
                        default:
                    }
                    var headNum = snake.position + snake.head[0] + snake.head[1] * bg.x;
                    var n = headNum % bg.x;
                    //判断是否撞墙
                    if (headNum < snake.area.min || headNum > snake.area.max || n == 0 || n == bg.x - 1 || n == 1 || n == bg.x - 2) {
                        snake.gameover(id);
                        pixel.shine();
                    } else {
                        var newhead = snake.head.slice();
                        var crossed = snake.check(snake.model, snake.head);
                        //判断是否交叉撞到身体
                        if (crossed) {
                            snake.gameover(id);
                            pixel.shine();
                        } else {
                            //加入新的头部
                            snake.model.push(newhead);
                            //显示头部
                            pixel.layout(snake.position, [newhead], 'show');
                            //判断是否吃到食物
                            if (first != headNum) {
                                //隐藏尾部
                                pixel.layout(snake.position, [snake.model.shift()], 'hide');
                            } else {
                                first = food();
                                pixel.layout(first, [[0, 0]], 'show');
                                snake.scroe += 10;
                                pixel.printWord('score:' + snake.scroe, (bg.x * 7 / 2)._floor());
                                //连吃5个加速80%
                                if (snake.scroe % 50 == 0) {
                                    snake.speed *= .8;
                                    clearInterval(id);
                                    move(m);
                                }
                            }
                        }
                    }
                    //自动模式
                    if (m == 'auto') {
                        (function () {
                            var line = (function () {
                                var line1 = (headNum / bg.x)._floor();
                                var line2 = (first / bg.x)._floor();
                                if (line1 == line2) {
                                    return true;
                                }
                            })();
                            //食物在下面
                            if (!line && headNum < first) {
                                snake.turn(40);
                                return;
                            }
                            //上面
                            if (!line && headNum > first) {
                                snake.turn(38);
                                return;
                            }
                            //右面
                            if (line && headNum < first) {
                                snake.turn(39);
                                return;
                            }
                            //左面
                            if (line && headNum > first) {
                                snake.turn(37);
                            }
                        })();

                        //A*算法
                    }
                }, {
                    end: snake.end,
                    speed: snake.speed
                });
            };
            move(m);
        }
    })()
</script>
</body>
</html>
